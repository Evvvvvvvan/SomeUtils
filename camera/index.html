<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ‘„åƒå¤´æµ‹è¯• - Axuan</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      text-align: center;
      padding: 20px;
    }
    video {
      width: 90%;
      max-width: 400px;
      border: 2px solid #333;
      border-radius: 10px;
      margin: 10px 0;
    }
    canvas {
      display: none;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
      color: #0066cc;
    }
  </style>
</head>
<body>
  <h2>ğŸ“· æ‘„åƒå¤´æµ‹è¯• - Axuan</h2>
  
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="status">ç­‰å¾…æ“ä½œ...</div>

  <div>
    <button id="openBtn">æ‰“å¼€æ‘„åƒå¤´</button>
    <button id="closeBtn" disabled>å…³é—­æ‘„åƒå¤´</button>
    <button id="flipBtn" disabled>ç¿»è½¬æ‘„åƒå¤´</button>
    <button id="captureBtn" disabled>æ‹ç…§</button>
    <button id="recordBtn" disabled>å¼€å§‹å½•åƒ</button>
    <button id="stopRecordBtn" disabled>åœæ­¢å½•åƒ</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const status = document.getElementById('status');
    const openBtn = document.getElementById('openBtn');
    const closeBtn = document.getElementById('closeBtn');
    const flipBtn = document.getElementById('flipBtn');
    const captureBtn = document.getElementById('captureBtn');
    const recordBtn = document.getElementById('recordBtn');
    const stopRecordBtn = document.getElementById('stopRecordBtn');

    let stream = null;
    let usingFrontCamera = false;
    let mediaRecorder = null;
    let recordedChunks = [];

    async function openCamera() {
      if (stream) {
        status.textContent = "æ‘„åƒå¤´å·²å¯åŠ¨";
        return;
      }

      const constraints = {
        video: { facingMode: usingFrontCamera ? "user" : "environment" },
        audio: false
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        openBtn.disabled = true;
        closeBtn.disabled = false;
        flipBtn.disabled = false;
        captureBtn.disabled = false;
        recordBtn.disabled = false;

        status.textContent = "æ‘„åƒå¤´å·²å¯åŠ¨";
      } catch (err) {
        console.error("æ‘„åƒå¤´æ‰“å¼€å¤±è´¥ï¼š", err);
        status.textContent = "æ‘„åƒå¤´æ‰“å¼€å¤±è´¥ï¼š" + err.message;
        alert("æ‘„åƒå¤´è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å…è®¸æµè§ˆå™¨ä½¿ç”¨æ‘„åƒå¤´ï¼");
      }
    }

    function closeCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      video.srcObject = null;

      openBtn.disabled = false;
      closeBtn.disabled = true;
      flipBtn.disabled = true;
      captureBtn.disabled = true;
      recordBtn.disabled = true;
      stopRecordBtn.disabled = true;

      status.textContent = "æ‘„åƒå¤´å·²å…³é—­";
    }

    function flipCamera() {
      usingFrontCamera = !usingFrontCamera;
      closeCamera();
      openCamera();
    }

    function capturePhoto() {
      if (!stream) {
        alert("è¯·å…ˆæ‰“å¼€æ‘„åƒå¤´ï¼");
        return;
      }
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imgData = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = imgData;
      a.download = "capture.png";
      a.click();

      status.textContent = "ç…§ç‰‡å·²ä¿å­˜";
    }

    function startRecording() {
      if (!stream) {
        alert("è¯·å…ˆæ‰“å¼€æ‘„åƒå¤´ï¼");
        return;
      }
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "recorded.webm";
        a.click();

        status.textContent = "å½•åƒå·²ä¿å­˜";
      };

      mediaRecorder.start();
      recordBtn.disabled = true;
      stopRecordBtn.disabled = false;
      status.textContent = "æ­£åœ¨å½•åƒ...";
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      recordBtn.disabled = false;
      stopRecordBtn.disabled = true;
    }

    // æŒ‰é’®äº‹ä»¶
    openBtn.addEventListener("click", openCamera);
    closeBtn.addEventListener("click", closeCamera);
    flipBtn.addEventListener("click", flipCamera);
    captureBtn.addEventListener("click", capturePhoto);
    recordBtn.addEventListener("click", startRecording);
    stopRecordBtn.addEventListener("click", stopRecording);
  </script>
</body>
</html>
