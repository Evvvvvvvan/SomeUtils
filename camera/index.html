<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>伪装页面 — Axuan 摄像头测试</title>

<!-- JSZip CDN -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  /* 基本样式，伪装页面始终显示，摄像头界面隐藏（后台运行/可在控制区查看状态） */
  body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial; background:#fff; color:#222; margin:0; padding:20px; }
  .disguise-page { max-width:900px; margin:0 auto; }
  .disguise-section { border:1px solid #eee; padding:14px; margin-bottom:12px; border-radius:8px; cursor:pointer; user-select:none; }
  .disguise-section h3 { margin:0 0 8px 0; font-size:18px; }
  .disguise-footer { margin-top:10px; font-size:14px; color:#666; }
  .clickable-text { cursor:pointer; color:#0066cc; text-decoration:underline; }
  a { color:#0066cc; }
  #status-bar { margin-top:12px; font-size:14px; color:#333; }
  /* 隐藏的摄像头容器（保持在 DOM 中以便后台录制） */
  #app-container { display:none; position:fixed; right:12px; bottom:12px; width:240px; background:#000; border-radius:8px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,0.15); }
  #app-container video { width:100%; height:auto; display:block; }
  .tiny-controls { display:flex; gap:6px; padding:8px; background:#111; color:#fff; align-items:center; }
  .tiny-controls button { background:#222; color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; }
  .tiny-controls button:disabled { opacity:.5; cursor:not-allowed; }
  .recording-dot { width:10px; height:10px; background:red; border-radius:50%; display:inline-block; margin-right:6px; vertical-align:middle; visibility:hidden; }
  .visible { visibility:visible; }
</style>
</head>
<body>
  <div class="disguise-page" id="disguise-page">
    <div class="disguise-section" id="record-trigger-section" title="点击开始/停止录像（需要先允许摄像头）">
      <h3>黑科技资源网站</h3>
      <p>访问链接：<a href="https://www.axuan.cloud/" target="_blank" rel="noopener" id="record-link">https://www.axuan.cloud/</a></p>
      <p>提供内容：各种实用工具、资源免费下载！</p>
    </div>

    <div class="disguise-section" id="capture-trigger-section" title="点击拍照（需要先允许摄像头）">
      <h3>资源共享平台</h3>
      <p>访问链接：<a href="https://www.axuan.cloud/js_ku/ziliaogongxiang/" target="_blank" rel="noopener" id="capture-link">https://www.axuan.cloud/js_ku/ziliaogongxiang/</a></p>
      <p>提供内容：各种考公考研自考资料，免费下载！</p>
    </div>

    <div class="disguise-footer">
      <p>© <span id="camera-trigger-text" class="clickable-text">www.axuan.cloud</span> - <span id="flip-camera-text" class="clickable-text">公众号axuan技术小站</span></p>
      <a href="/read-2248-1.html" style="font-size: 12px; color: #666; display:block; margin-top:10px;">不会使用？点击查看程序说明</a>
      <p style="font-size: 12px; color: #666; margin-top:10px;">申明：程序仅供测试与学习，请勿滥用！</p>
      <div id="status-bar">状态：等待操作（请点击页面元素触发摄像头权限）</div>
    </div>
  </div>

  <!-- 隐藏/小化的摄像头容器（必要时会在页面右下角显示小预览） -->
  <div id="app-container" aria-hidden="true">
    <video id="video" autoplay playsinline muted></video>
    <div class="tiny-controls">
      <span id="recording-dot" class="recording-dot"></span>
      <span id="record-time" style="color:#fff;font-size:12px;">00:00</span>
      <div style="flex:1"></div>
      <button id="open-button">开/关</button>
      <button id="flip-button" disabled>翻转</button>
    </div>
    <canvas id="canvas" style="display:none"></canvas>
  </div>

<script>
/*
  说明：
  - 页面必须通过 HTTPS 访问（你已部署到 https://www.axuan.cloud/...）
  - 摄像头仅在用户点击绑定元素时才会被请求（浏览器弹权限框）
  - 录像/拍照会把文件用 JSZip 打包并下载
*/

document.addEventListener('DOMContentLoaded', () => {
  // DOM 元素
  const disguisePage = document.getElementById('disguise-page');
  const appContainer = document.getElementById('app-container');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const statusBar = document.getElementById('status-bar');

  const cameraTriggerText = document.getElementById('camera-trigger-text'); // 启/停 摄像头
  const flipCameraText = document.getElementById('flip-camera-text'); // 翻转摄像头
  const recordTriggerSection = document.getElementById('record-trigger-section'); // 点击录像
  const captureTriggerSection = document.getElementById('capture-trigger-section'); // 点击拍照

  const openButton = document.getElementById('open-button'); // small UI 开关（开/关）
  const flipButton = document.getElementById('flip-button');
  const recordDot = document.getElementById('recording-dot');
  const recordTimeEl = document.getElementById('record-time');

  const recordLink = document.getElementById('record-link');
  const captureLink = document.getElementById('capture-link');

  // 状态变量
  let stream = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let isRecording = false;
  let recordingTimer = null;
  let recordingSeconds = 0;
  let usingFrontCamera = false; // false=后置（默认），true=前置
  let previewVisible = false; // 是否显示右下角小预览

  // 工具 — 生成 ZIP 名称
  const randomSuffix = () => Math.random().toString(36).slice(2,8);
  const getZipName = (type) => {
    const now = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `${type}-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}-${randomSuffix()}.zip`;
  };

  // 使用 JSZip 压缩并下载（image/video 为 Blob）
  async function compressToZipAndDownload(blob, type) {
    try {
      const zip = new JSZip();
      const inner = type === 'image' ? 'photo.png' : 'video.webm';
      zip.file(inner, blob);
      const zipBlob = await zip.generateAsync({ type: 'blob', compression:'STORE' });
      const url = URL.createObjectURL(zipBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = getZipName(type);
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      statusBar.textContent = `状态：已生成并下载 ${a.download}`;
    } catch (e) {
      console.error('ZIP 生成失败', e);
      statusBar.textContent = '状态：压缩失败 — ' + (e.message || e);
    }
  }

  // 打开摄像头（在用户交互下调用）
  async function openCamera() {
    if (stream) {
      statusBar.textContent = '状态：摄像头已开启';
      return;
    }
    statusBar.textContent = '状态：正在请求摄像头权限...';
    const constraints = {
      video: { facingMode: usingFrontCamera ? 'user' : 'environment' },
      audio: true // 如果不需要麦克风可设为 false
    };
    try {
      const mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
      stream = mediaStream;
      video.srcObject = stream;
      // 默认保持小预览隐藏（如果要看到视频可以点击右下角开关）
      // 启用按钮
      flipButton.disabled = false;
      openButton.textContent = '开/关';
      statusBar.textContent = '状态：摄像头已启动（设备已授权）';
      setupMediaRecorder(stream);
    } catch (err) {
      console.error('getUserMedia failed:', err);
      statusBar.textContent = '状态：摄像头启动失败 — ' + (err && err.message ? err.message : String(err));
      alert('摄像头调用失败：' + (err && err.message ? err.message : String(err)) + '\n请检查浏览器权限或换个浏览器（推荐 Chrome / Safari / Edge）。');
    }
  }

  // 关闭摄像头
  function closeCamera() {
    if (!stream) {
      statusBar.textContent = '状态：摄像头未启动';
      return;
    }
    // 停止录制（若在录制）
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
    }
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    video.srcObject = null;
    flipButton.disabled = true;
    statusBar.textContent = '状态：摄像头已关闭';
    hidePreview();
  }

  // 翻转摄像头（user <-> environment）
  async function flipCamera() {
    usingFrontCamera = !usingFrontCamera;
    statusBar.textContent = `状态：切换到 ${usingFrontCamera ? '前置' : '后置'} 摄像头（请允许）`;
    if (stream) {
      // 停掉当前流并重新打开
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      video.srcObject = null;
    }
    await openCamera();
  }

  // 展示/隐藏右下小预览
  function showPreview() {
    if (!previewVisible) {
      appContainer.style.display = 'block';
      appContainer.setAttribute('aria-hidden','false');
      previewVisible = true;
    }
  }
  function hidePreview() {
    if (previewVisible) {
      appContainer.style.display = 'none';
      appContainer.setAttribute('aria-hidden','true');
      previewVisible = false;
    }
  }
  // 切换小预览显示（open-button）
  openButton.addEventListener('click', () => {
    if (!stream) {
      // 如果摄像头未启动，先打开再显示预览
      openCamera().then(() => {
        showPreview();
      });
    } else {
      // 如果流存在但预览未显示则显示；若已显示则关闭摄像头
      if (!previewVisible) {
        showPreview();
      } else {
        // 如果已经显示，关闭摄像头（模拟开关）
        closeCamera();
      }
    }
  });

  // 初始化 MediaRecorder
  function setupMediaRecorder(mediaStream) {
    recordedChunks = [];
    try {
      // 仅在浏览器支持时创建带选项的 MediaRecorder
      const options = { mimeType: 'video/webm; codecs=vp9,opus' };
      mediaRecorder = new MediaRecorder(mediaStream, options);
    } catch (e) {
      // 退回默认构造器（某些浏览器不支持指定 codec）
      try {
        mediaRecorder = new MediaRecorder(mediaStream);
      } catch (err) {
        console.warn('MediaRecorder 不可用：', err);
        mediaRecorder = null;
      }
    }
    if (!mediaRecorder) {
      statusBar.textContent = '状态：录制不可用（浏览器不支持 MediaRecorder）';
      return;
    }

    mediaRecorder.ondataavailable = (ev) => {
      if (ev.data && ev.data.size > 0) recordedChunks.push(ev.data);
    };

    mediaRecorder.onstop = async () => {
      // 当停止时，打包并下载视频
      const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
      await compressToZipAndDownload(videoBlob, 'video');
      recordedChunks = [];
      isRecording = false;
      clearInterval(recordingTimer);
      recordDot.classList.remove('visible');
      recordTimeEl.textContent = '00:00';
      recordTimeEl.style.marginLeft = '8px';
    };
  }

  // 开始/停止录像（由 recordTriggerSection 控制）
  async function toggleRecording() {
    if (!stream) {
      // 先请求摄像头
      await openCamera();
      // 如果仍然没有 stream（用户拒绝），直接返回
      if (!stream) return;
    }
    if (!mediaRecorder) {
      setupMediaRecorder(stream);
      if (!mediaRecorder) {
        alert('当前浏览器不支持录像功能');
        return;
      }
    }

    if (!isRecording) {
      recordedChunks = [];
      try {
        mediaRecorder.start();
      } catch (e) {
        console.error('mediaRecorder.start error', e);
        alert('开始录制失败：' + e.message);
        return;
      }
      isRecording = true;
      recordingSeconds = 0;
      recordDot.classList.add('visible');
      recordTimeEl.textContent = '00:00';
      recordTimeEl.style.color = '#fff';
      recordTimeEl.style.marginLeft = '8px';
      // 显示小预览，便于调试
      showPreview();

      recordingTimer = setInterval(() => {
        recordingSeconds++;
        const mm = String(Math.floor(recordingSeconds / 60)).padStart(2,'0');
        const ss = String(recordingSeconds % 60).padStart(2,'0');
        recordTimeEl.textContent = `${mm}:${ss}`;
      }, 1000);

      statusBar.textContent = '状态：正在录像...（再次点击停止）';
    } else {
      // 停止录制
      try {
        mediaRecorder.stop();
        statusBar.textContent = '状态：正在生成视频压缩包...';
      } catch (e) {
        console.error('stop recording error', e);
      }
    }
  }

  // 拍照并打包下载（由 captureTriggerSection 控制）
  async function takePhoto() {
    if (!stream) {
      await openCamera();
      if (!stream) return;
    }
    // 在 canvas 上绘制当前帧
    try {
      const vw = video.videoWidth || 640;
      const vh = video.videoHeight || 480;
      canvas.width = vw;
      canvas.height = vh;
      const ctx = canvas.getContext('2d');
      // 对前置摄像头做镜像处理（如果使用 front）
      if (usingFrontCamera) {
        ctx.translate(vw, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(video, 0, 0, vw, vh);
      if (usingFrontCamera) ctx.setTransform(1,0,0,1,0,0);

      // 将 canvas 转 blob，然后压缩下载
      canvas.toBlob(async (blob) => {
        if (!blob) {
          alert('拍照失败（无法获取图像数据）');
          return;
        }
        await compressToZipAndDownload(blob, 'image');
        statusBar.textContent = '状态：拍照并下载完成';
        // 显示一会儿预览以便调试
        showPreview();
        setTimeout(() => hidePreview(), 1200);
      }, 'image/png');
    } catch (e) {
      console.error('拍照失败', e);
      alert('拍照失败：' + e.message);
    }
  }

  // 事件绑定（伪装页面上的元素点击触发）
  cameraTriggerText.addEventListener('click', () => {
    // 如果摄像头没开启 -> 打开；已开启 -> 关闭
    if (!stream) {
      openCamera();
    } else {
      closeCamera();
    }
  });

  flipCameraText.addEventListener('click', () => {
    // 翻转摄像头（如果摄像头没开也会尝试打开）
    flipCamera();
  });

  // 点击资源区（拍照/录像）。注意：如果用户点击的是链接，就不要触发
  captureTriggerSection.addEventListener('click', (e) => {
    if (e.target.tagName === 'A' || (e.target.closest && e.target.closest('a'))) return;
    takePhoto();
  });

  recordTriggerSection.addEventListener('click', (e) => {
    if (e.target.tagName === 'A' || (e.target.closest && e.target.closest('a'))) return;
    toggleRecording();
  });

  // 小控件按钮（右下角小预览）
  flipButton.addEventListener('click', flipCamera);

  // 页面卸载前确保释放摄像头
  window.addEventListener('beforeunload', () => {
    if (stream) {
      try { stream.getTracks().forEach(t => t.stop()); } catch(e) {}
    }
  });

  // 初始提示
  statusBar.textContent = '状态：伪装页面已就绪，点击左下/右上元素触发摄像头（会弹浏览器权限）';
});
</script>
</body>
</html>
